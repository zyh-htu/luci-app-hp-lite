#!/bin/sh /etc/rc.common

START=99
STOP=10
USE_PROCD=1

PROG=/usr/bin/hp-lite
WORKDIR=/tmp/hp-lite
CONFIG=/etc/config/hp-lite

start_service() {
    local code=$(uci get hp-lite.global.connect_code 2>/dev/null)
    [ -z "$code" ] && {
        echo "No connect code configured, please set it in LuCI"
        return 1
    }
    
    procd_open_instance
    procd_set_param command $PROG -c=$code
    procd_set_param respawn
    procd_set_param stdout 1
    procd_set_param stderr 1
    procd_set_param cwd "$WORKDIR"
    procd_close_instance 
}

stop_service() {
    procd_stop_instance "$PROG" 2>/dev/null
    local pids=$(pgrep -f "$PROG")
    if [ -n "$pids" ]; then
        for pid in $pids; do
            kill -9 "$pid" 2>/dev/null
        done
        pkill -9 -f "$PROG" 2>/dev/null
    fi
}